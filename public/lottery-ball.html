<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>äº’åŠ¨æ°”æ³¡æŠ½å¥– - ä¸¥è°¨ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { margin: 0; background-color: #1D224D; color: white; font-family: sans-serif; overflow: hidden; }
        
        /* æ‚¬æµ®ä¾§è¾¹æ  */
        .floating-sidebar { 
            position: absolute; left: 20px; top: 100px; bottom: 100px; width: 200px; 
            background: rgba(44, 48, 83, 0.6); backdrop-filter: blur(5px);
            border: 1px solid rgba(56, 198, 149, 0.3); border-radius: 15px; 
            padding: 15px; z-index: 20; display: flex; flex-direction: column;
        }
        .sidebar-header { color: #38C695; font-size: 0.9rem; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; margin-bottom: 10px; }
        .p-list { flex-grow: 1; overflow-y: auto; font-size: 0.85rem; color: #eee; margin: 0; padding: 0; list-style: none; }
        .p-list li { margin-bottom: 6px; opacity: 0.8; }

        canvas { position: absolute; top: 0; left: 0; z-index: 5; }
        .header { position: relative; padding: 20px; z-index: 10; text-align: center; pointer-events: none; }
        .header * { pointer-events: auto; }
        select { padding: 6px; border-radius: 5px; background: #2C3053; color: white; border: 1px solid #38C695; }
        
        .ui-layer { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); z-index: 10; }
        button#action-btn { padding: 12px 40px; font-size: 1.1rem; background: #38C695; color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
        
        #result-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; color: #333; padding: 30px; border-radius: 20px; width: 500px; text-align: center; z-index: 100; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        .btn-link { background: #4A5073; color: white; text-decoration: none; padding: 10px 20px; border-radius: 5px; margin: 5px; display: inline-block; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="header">
        <h2 id="session-title">åŠ è½½ä¸­...</h2>
        æ—¥æœŸï¼š<select id="date-selector"></select>
    </div>

    <div class="floating-sidebar">
        <div class="sidebar-header" id="sidebar-header">æœ‰æ•ˆæŠ½å¥– (0)</div>
        <ul id="p-list" class="p-list"></ul>
    </div>

    <canvas id="ballCanvas"></canvas>

    <div class="ui-layer"><button id="action-btn">å¼€å§‹ç¢°æ’</button></div>

    <div id="result-modal">
        <h2 style="color: #FFD700">ğŸ‰ æŠ½ä¸­å•¦ï¼</h2>
        <div id="lucky-text" style="font-size: 1.3rem; margin: 20px 0;"></div>
        <div id="lucky-name" style="color: #38C695; font-weight: bold;"></div>
        <div style="margin-top: 25px;">
            <a href="#" id="jump-btn" class="btn-link" style="background:#38C695;">ğŸ”— å±•ç¤ºå¢™å®šä½</a>
            <a href="/records.html" class="btn-link">ğŸ“œ æŸ¥çœ‹è®°å½•</a>
            <button onclick="location.reload()" style="padding:10px 20px; border:none; cursor:pointer; border-radius:5px;">å†æŠ½ä¸€æ¬¡</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('ballCanvas');
        const ctx = canvas.getContext('2d');
        const urlParams = new URLSearchParams(window.location.search);
        const sessionCode = urlParams.get('code');
        const targetDate = urlParams.get('date');
        let balls = [], allQuestions = [], filteredPool = [], isRunning = false, sessionName = "";

        function calculateDifference(s1, s2) {
            const len1 = s1.length, len2 = s2.length;
            const matrix = Array.from({ length: len1 + 1 }, () => []);
            for (let i = 0; i <= len1; i++) matrix[i][0] = i;
            for (let j = 0; j <= len2; j++) matrix[0][j] = j;
            for (let i = 1; i <= len1; i++) {
                for (let j = 1; j <= len2; j++) {
                    const cost = s1[i-1] === s2[j-1] ? 0 : 1;
                    matrix[i][j] = Math.min(matrix[i-1][j]+1, matrix[i][j-1]+1, matrix[i-1][j-1]+cost);
                }
            }
            return Math.max(len1, len2) === 0 ? 0 : matrix[len1][len2] / Math.max(len1, len2);
        }

        async function init() {
            const resp = await fetch(`/api/sessions/${sessionCode}`);
            const data = await resp.json();
            allQuestions = data.questions;
            sessionName = data.session.name;
            document.getElementById('session-title').textContent = sessionName;

            const dates = [...new Set(allQuestions.map(q => new Date(q.createdAt).toLocaleDateString('ja-JP')))].sort().reverse();
            const selector = document.getElementById('date-selector');
            selector.innerHTML = dates.map(d => `<option value="${d}">${d}</option>`).join('');
            if (targetDate && dates.includes(targetDate)) selector.value = targetDate;

            selector.onchange = () => {
                const raw = allQuestions.filter(q => new Date(q.createdAt).toLocaleDateString('ja-JP') === selector.value);
                processPool(raw);
            };
            selector.onchange(); resize(); animate();
        }

        function processPool(raw) {
            const grouped = {};
            raw.forEach(q => {
                if (!grouped[q.name]) grouped[q.name] = [];
                if (!grouped[q.name].some(ext => calculateDifference(ext.text, q.text) <= 0.25)) {
                    grouped[q.name].push(q);
                }
            });

            filteredPool = Object.values(grouped).flat();
            document.getElementById('sidebar-header').textContent = `æœ‰æ•ˆæŠ½å¥– (${filteredPool.length})`;
            document.getElementById('p-list').innerHTML = Object.entries(grouped)
                .map(([name, qs]) => `<li>${name} (${qs.length})</li>`).join('');
            
            balls = filteredPool.map(q => new Ball(q));
        }

        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.onresize = resize;

        class Ball {
            constructor(q) {
                this.q = q; this.radius = 40 + Math.random() * 20;
                this.x = Math.random() * (canvas.width - 100) + 50;
                this.y = Math.random() * (canvas.height - 100) + 50;
                this.dx = (Math.random() - 0.5) * 10; this.dy = (Math.random() - 0.5) * 10;
                this.color = `hsl(${Math.random() * 360}, 60%, 65%)`;
            }
            draw() {
                ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = this.color; ctx.fill(); ctx.fillStyle = "white";
                ctx.textAlign = "center"; ctx.font = "12px sans-serif";
                ctx.fillText(this.q.name.substring(0,6), this.x, this.y + 5);
                ctx.closePath();
            }
            update() {
                if (isRunning) {
                    if (this.x + this.radius > canvas.width || this.x - this.radius < 0) this.dx = -this.dx;
                    if (this.y + this.radius > canvas.height || this.y - this.radius < 0) this.dy = -this.dy;
                    this.x += this.dx; this.y += this.dy;
                }
                this.draw();
            }
        }

        function animate() { ctx.clearRect(0, 0, canvas.width, canvas.height); balls.forEach(b => b.update()); requestAnimationFrame(animate); }

        document.getElementById('action-btn').onclick = function() {
            if (!isRunning) { isRunning = true; this.textContent = "åœï¼"; this.style.background = "#ff4757"; }
            else { stopLottery(); }
        };

        async function stopLottery() {
            isRunning = false;
            const lucky = balls[Math.floor(Math.random() * balls.length)].q;
            confetti({ particleCount: 200, spread: 90 });
            document.getElementById('lucky-text').textContent = lucky.text;
            document.getElementById('lucky-name').textContent = `æé—®äººï¼š${lucky.name}`;
            document.getElementById('jump-btn').href = `/session/${sessionCode}#q-${lucky._id}`;
            document.getElementById('result-modal').style.display = 'block';
            await fetch('/api/lottery-records', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sessionName, sessionCode, date: document.getElementById('date-selector').value,
                    questionText: lucky.text, userName: lucky.name
                })
            });
        }
        init();
    </script>
</body>
</html>