<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>äº’åŠ¨æŠ½å¥–</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { margin: 0; background-color: #1D224D; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        .setup-area { margin-bottom: 20px; }
        select { padding: 8px; border-radius: 5px; background: #2C3053; color: white; border: 1px solid #38C695; }
        #display-wall { width: 80%; max-width: 800px; height: 300px; background: rgba(44, 48, 83, 0.8); border: 3px solid #38C695; border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-shadow: 0 0 30px rgba(56, 198, 149, 0.3); }
        #rolling-text { font-size: 2.2rem; font-weight: bold; margin-bottom: 15px; text-align: center; overflow-wrap: break-word; max-width: 90%; }
        #rolling-name { font-size: 1.5rem; color: #38C695; }
        .controls { margin-top: 30px; display: flex; gap: 15px; }
        button { padding: 12px 35px; border-radius: 50px; border: none; font-size: 1.1rem; cursor: pointer; font-weight: bold; }
        #action-btn { background: #38C695; color: white; }
        .result-actions { display: none; gap: 10px; margin-top: 20px; }
        .btn-link { background: #4A5073; color: white; text-decoration: none; padding: 10px 20px; border-radius: 5px; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="setup-area">
        <h2 id="session-title">æ­£åœ¨åŠ è½½åœºæ¬¡...</h2>
        æ—¥æœŸï¼š<select id="date-selector"></select>
    </div>
    <div id="display-wall">
        <div id="rolling-text">è¯·å…ˆé€‰æ‹©æ—¥æœŸå¹¶ç‚¹å‡»å¼€å§‹</div>
        <div id="rolling-name">---</div>
        <div id="result-actions" class="result-actions">
            <a href="#" id="jump-btn" class="btn-link">ğŸ”— å±•ç¤ºå¢™å®šä½</a>
            <a href="/records.html" class="btn-link">ğŸ“œ ä¸­å¥–è®°å½•</a>
        </div>
    </div>
    <div class="controls">
        <button id="action-btn" disabled>åŠ è½½ä¸­...</button>
        <button onclick="window.history.back()" style="background:#2C3053; color:#aaa;">è¿”å›</button>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const sessionCode = urlParams.get('code');
        let allQuestions = [], filteredPool = [], luckyOne = null, isRolling = false, timer = null, sessionName = "";

        const textEl = document.getElementById('rolling-text');
        const nameEl = document.getElementById('rolling-name');
        const actionBtn = document.getElementById('action-btn');

        async function init() {
            const resp = await fetch(`/api/sessions/${sessionCode}`);
            const data = await resp.json();
            allQuestions = data.questions;
            sessionName = data.session.name;
            document.getElementById('session-title').textContent = sessionName;

            // è·å–ä¸é‡å¤çš„æ—¥æœŸåˆ—è¡¨
            const dates = [...new Set(allQuestions.map(q => new Date(q.createdAt).toLocaleDateString('ja-JP')))].sort().reverse();
            const selector = document.getElementById('date-selector');
            selector.innerHTML = dates.map(d => `<option value="${d}">${d}</option>`).join('');
            
            selector.onchange = () => {
                filteredPool = allQuestions.filter(q => new Date(q.createdAt).toLocaleDateString('ja-JP') === selector.value);
                textEl.textContent = `è¯¥æ—¥æœŸå…±æœ‰ ${filteredPool.length} æ¡é—®é¢˜`;
            };
            selector.onchange(); 
            actionBtn.disabled = false; actionBtn.textContent = "å¼€å§‹æŠ½å–";
        }

        actionBtn.onclick = () => {
            if (isRolling) stopRoll();
            else startRoll();
        };

        function startRoll() {
            if (filteredPool.length === 0) return alert("è¯¥æ—¥æœŸæ²¡é—®é¢˜ï¼");
            isRolling = true;
            document.getElementById('result-actions').style.display = 'none';
            actionBtn.textContent = "åœæ­¢";
            timer = setInterval(() => {
                luckyOne = filteredPool[Math.floor(Math.random() * filteredPool.length)];
                textEl.textContent = luckyOne.text;
                nameEl.textContent = `æé—®äººï¼š${luckyOne.name}`;
            }, 50);
        }

        async function stopRoll() {
            clearInterval(timer);
            isRolling = false;
            actionBtn.textContent = "å†æŠ½ä¸€æ¬¡";
            confetti({ particleCount: 150, spread: 70 });
            
            // æ˜¾ç¤ºè·³è½¬æŒ‰é’®
            document.getElementById('jump-btn').href = `/session/${sessionCode}#q-${luckyOne._id}`;
            document.getElementById('result-actions').style.display = 'flex';
            textEl.style.color = "#FFD700";

            // ä¿å­˜è®°å½•
            await fetch('/api/lottery-records', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sessionName: sessionName,
                    sessionCode: sessionCode,
                    date: document.getElementById('date-selector').value,
                    questionText: luckyOne.text,
                    userName: luckyOne.name
                })
            });
        }
        init();
    </script>
</body>
</html>