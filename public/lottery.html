<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>äº’åŠ¨æŠ½å¥–</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { margin: 0; background-color: #1D224D; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        .setup-area { margin-bottom: 20px; }
        select { padding: 8px; border-radius: 5px; background: #2C3053; color: white; border: 1px solid #38C695; }
        
        #display-wall { 
            width: 80%; max-width: 800px; height: 320px; 
            background: rgba(44, 48, 83, 0.8); border: 3px solid #38C695; 
            border-radius: 20px; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; padding: 25px; 
            box-shadow: 0 0 30px rgba(56, 198, 149, 0.3);
            text-align: center;
        }

        #rolling-text { 
            font-size: 2.2rem; font-weight: bold; margin-bottom: 15px; 
            overflow-wrap: break-word; max-width: 100%; 
            line-height: 1.3;
            transition: color 0.3s;
        }
        #rolling-name { font-size: 1.5rem; color: #38C695; margin-bottom: 20px; }

        .controls { margin-top: 30px; display: flex; gap: 15px; }
        button { padding: 12px 35px; border-radius: 50px; border: none; font-size: 1.1rem; cursor: pointer; font-weight: bold; }
        #action-btn { background: #38C695; color: white; }
        
        .result-actions { display: none; gap: 10px; }
        .btn-link { background: #4A5073; color: white; text-decoration: none; padding: 10px 20px; border-radius: 5px; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="setup-area">
        <h2 id="session-title">æ­£åœ¨åŠ è½½åœºæ¬¡...</h2>
        æ—¥æœŸï¼š<select id="date-selector"></select>
    </div>
    <div id="display-wall">
        <div id="rolling-text">è¯·å…ˆé€‰æ‹©æ—¥æœŸå¹¶ç‚¹å‡»å¼€å§‹</div>
        <div id="rolling-name">---</div>
        <div id="result-actions" class="result-actions">
            <a href="#" id="jump-btn" class="btn-link">ğŸ”— å±•ç¤ºå¢™å®šä½</a>
            <a href="/records.html" class="btn-link">ğŸ“œ ä¸­å¥–è®°å½•</a>
        </div>
    </div>
    <div class="controls">
        <button id="action-btn" disabled>åŠ è½½ä¸­...</button>
        <button onclick="window.history.back()" style="background:#2C3053; color:#aaa;">è¿”å›</button>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const sessionCode = urlParams.get('code');
        const targetDate = urlParams.get('date'); // è·å–ä»å±•ç¤ºå¢™ä¼ æ¥çš„æ—¥æœŸ
        
        let allQuestions = [], filteredPool = [], luckyOne = null, isRolling = false, timer = null, sessionName = "";

        const textEl = document.getElementById('rolling-text');
        const nameEl = document.getElementById('rolling-name');
        const actionBtn = document.getElementById('action-btn');
        const selector = document.getElementById('date-selector');

        async function init() {
            const resp = await fetch(`/api/sessions/${sessionCode}`);
            const data = await resp.json();
            allQuestions = data.questions;
            sessionName = data.session.name;
            document.getElementById('session-title').textContent = sessionName;

            const dates = [...new Set(allQuestions.map(q => new Date(q.createdAt).toLocaleDateString('ja-JP')))].sort().reverse();
            selector.innerHTML = dates.map(d => `<option value="${d}">${d}</option>`).join('');
            
            // æ ¸å¿ƒä¿®æ”¹ 1ï¼šå¦‚æœ URL æœ‰æ—¥æœŸï¼Œåˆ™è‡ªåŠ¨é”å®šè¯¥æ—¥æœŸ
            if (targetDate && dates.includes(targetDate)) {
                selector.value = targetDate;
            }

            selector.onchange = () => {
                filteredPool = allQuestions.filter(q => new Date(q.createdAt).toLocaleDateString('ja-JP') === selector.value);
                textEl.textContent = `è¯¥æ—¥æœŸå…±æœ‰ ${filteredPool.length} æ¡é—®é¢˜`;
                nameEl.textContent = "---";
                textEl.style.color = "white";
                document.getElementById('result-actions').style.display = 'none';
            };
            
            selector.onchange(); 
            actionBtn.disabled = false; 
            actionBtn.textContent = "å¼€å§‹æŠ½å–";
        }

        actionBtn.onclick = () => {
            if (isRolling) stopRoll();
            else startRoll();
        };

        function startRoll() {
            if (filteredPool.length === 0) return alert("è¯¥æ—¥æœŸæ²¡é—®é¢˜ï¼");
            isRolling = true;
            document.getElementById('result-actions').style.display = 'none';
            actionBtn.textContent = "åœæ­¢";
            textEl.style.color = "white";

            timer = setInterval(() => {
                luckyOne = filteredPool[Math.floor(Math.random() * filteredPool.length)];
                
                // æ ¸å¿ƒä¿®æ”¹ 2ï¼šæ»šåŠ¨è¿‡ç¨‹ä¸­å¯¹é•¿æ–‡æœ¬è¿›è¡Œæˆªæ–­
                const maxLength = 25; // é™åˆ¶ 25 ä¸ªå­—ç¬¦
                let displayText = luckyOne.text;
                if (displayText.length > maxLength) {
                    displayText = displayText.substring(0, maxLength) + "â€¦â€¦";
                }
                
                textEl.textContent = displayText;
                nameEl.textContent = `æé—®äººï¼š${luckyOne.name}`;
            }, 60);
        }

        async function stopRoll() {
            clearInterval(timer);
            isRolling = false;
            actionBtn.textContent = "å†æŠ½ä¸€æ¬¡";
            confetti({ particleCount: 150, spread: 70 });
            
            // ä¸­å¥–æ—¶æ˜¾ç¤ºå®Œæ•´é—®é¢˜
            textEl.textContent = luckyOne.text;
            textEl.style.color = "#FFD700"; // é‡‘è‰²é«˜äº®

            document.getElementById('jump-btn').href = `/session/${sessionCode}#q-${luckyOne._id}`;
            document.getElementById('result-actions').style.display = 'flex';

            await fetch('/api/lottery-records', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sessionName: sessionName,
                    sessionCode: sessionCode,
                    date: selector.value,
                    questionText: luckyOne.text,
                    userName: luckyOne.name
                })
            });
        }
        init();
    </script>
</body>
</html>